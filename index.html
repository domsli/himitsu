<!DOCTYPE html>
<html>
  <head>
    <!-- Theme included stylesheets -->
    <link href="https://cdn.quilljs.com/1.0.0/quill.snow.css" rel="stylesheet">

    <!-- Pikaday -->
    <link rel="stylesheet" href="pikaday/css/pikaday.css">
    <script src="pikaday/pikaday.js"></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!-- My stuff -->
    <link href="css/style.css" rel="stylesheet">
  </head>

  <body>
    <!-- Main Quill library -->
    <!-- Note that this needs to be loaded in body to ensure that document.body is
         defined when using the editor. document.body happens to be a dependency. -->
    <script src="https://cdn.quilljs.com/1.0.0/quill.js"></script>

    <!-- Date picker UI -->
    <input id="datepicker" aria-label="Use the arrow keys to pick a date" type="text">

    <!-- Full container for quill (including the toolbar) -->
    <div id="quill-text-editor">
      <!-- Quill editor container -->
      <div id="quill-editor"></div>
    </div>

    <script>
      // Get the contents for today's daily
      var getDailyFromDate = function(date) {
        $.get({
          url: "/daily/" + date.getFullYear() + "/" + date.getMonth() + "/" + date.getDate(),
          datatype: "json",
          success: function(data, err) {
            console.log("Successfully got daily for", date);
            if (data) {
              editor.setContents(JSON.parse(data.content));
            }
            else {
              editor.setContents(""); // empty contents
            }
            change = new Delta(); // change is initialized below
          },
          error: function(err) {
            console.log("Failed to get daily for", date);
            console.log(err);
          }
        });
      };

      // Load the date picker
      var picker = new Pikaday({
        field: document.getElementById('datepicker'),
        onSelect: getDailyFromDate,
        firstDay: 1,
        maxDate: new Date(2020, 12, 31),
        yearRange: [2000,2020],
      });
      picker.setDate(new Date());

      // Load the editor
      var Delta = Quill.import('delta');
      var editor = new Quill('#quill-editor', {
        placeholder: 'Write about your day',
        theme: 'snow',
      });

      // Store accumulated changes
      var change = new Delta();
      editor.on('text-change', function(delta) {
        change = change.compose(delta);
      });

      // Auto-save changes to the daily
      setInterval(function() {
        if (change.length() > 0) {
          var date = picker.getDate();
          var content = JSON.stringify(editor.getContents());
          $.ajax({
            method: 'PUT',
            url: "/daily/" + date.getFullYear() + "/" + date.getMonth() + "/" + date.getDate(),
            contentType: 'application/json',
            data: JSON.stringify({ content: content }),
            datatype: "json",
            success: function(data, err) {
              console.log("Successfully saved daily");
              change = new Delta();
            },
            error: function(err) {
              console.log("Failed to save daily");
              console.log(err);
            }
          });
        }
      }, 5000); // every 5 seconds
    </script>
  </body>
</html>